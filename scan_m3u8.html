<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÙØ­Øµ Ø±ÙˆØ§Ø¨Ø· M3U/M3U8</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 20px;
      direction: rtl;
      transition: all 0.3s ease;
      margin: 0;
      min-height: 100vh;
    }
    body.dark-mode {
      background: linear-gradient(135deg, #2c3e50 0%, #4b79a1 100%);
      color: #fff;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    body.dark-mode .container {
      background: #333;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      font-size: 2rem;
      margin-bottom: 20px;
    }
    body.dark-mode h1 {
      color: #ddd;
    }
    .input-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    body.dark-mode label {
      color: #ddd;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    input:focus, select:focus {
      border-color: #2196f3;
      outline: none;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
      margin: 5px;
    }
    .btn-primary { background: #2196f3; color: white; }
    .btn-primary:hover { background: #1976d2; }
    .btn-stop { background: #f44336; color: white; }
    .btn-stop:hover { background: #d32f2f; }
    .btn-clear { background: #ff9800; color: white; }
    .btn-clear:hover { background: #f57c00; }
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #progressContainer {
      width: 100%;
      background: #ddd;
      border-radius: 10px;
      margin: 15px 0;
      overflow: hidden;
    }
    #progressBar {
      width: 0%;
      height: 24px;
      background: #2196f3;
      border-radius: 10px;
      text-align: center;
      color: white;
      font-size: 14px;
      transition: width 0.3s ease;
    }
    #stats {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      font-size: 1rem;
      color: #555;
    }
    body.dark-mode #stats {
      color: #bbb;
    }
    #results {
      margin-top: 20px;
      max-height: 500px;
      overflow-y: auto;
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    body.dark-mode #results {
      background: #444;
      color: #ddd;
    }
    .channel-item {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 10px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .channel-item:hover {
      transform: translateY(-2px);
    }
    body.dark-mode .channel-item {
      background: #555;
    }
    .channel-item img {
      width: 60px;
      height: 60px;
      margin-left: 10px;
      object-fit: contain;
      border-radius: 4px;
      transition: opacity 0.3s;
    }
    .channel-item img[loading="lazy"] {
      opacity: 0.5;
    }
    .channel-item span {
      flex: 1;
      font-size: 1.1rem;
    }
    .play-btn {
      padding: 8px 16px;
      background: #4caf50;
      color: white;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: background 0.3s;
    }
    .play-btn:hover {
      background: #45a049;
    }
    .toggle-container {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
    }
    .loader {
      display: none;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2196f3;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 120px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      right: 50%;
      transform: translateX(50%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    .video-player {
      display: none;
      margin-top: 20px;
      text-align: center;
    }
    video {
      max-width: 100%;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      h1 {
        font-size: 1.5rem;
      }
      .channel-item {
        flex-direction: column;
        align-items: flex-start;
      }
      .channel-item img {
        margin: 10px 0;
      }
    }
  </style>
</head>
<body>
  <div class="toggle-container">
    <label class="tooltip">ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¸Ù„Ù…
      <span class="tooltiptext">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¸Ù„Ù…</span>
    </label>
    <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
  </div>
  <div class="container">
    <h1><i class="fas fa-satellite-dish"></i> ÙØ­Øµ Ø±ÙˆØ§Ø¨Ø· M3U/M3U8</h1>
    <div class="input-group">
      <label><i class="fas fa-file-upload"></i> Ø±ÙØ¹ Ù…Ù„Ù M3U/M3U8</label>
      <input type="file" id="fileInput" accept=".m3u,.m3u8">
    </div>
    <div class="input-group">
      <label><i class="fas fa-link"></i> Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ù…Ù„Ù M3U/M3U8</label>
      <input type="text" id="listUrl" placeholder="https://example.com/playlist.m3u8" value="https://iptv-org.github.io/iptv/index.m3u">
    </div>
    <div class="input-group">
      <label><i class="fas fa-tv"></i> Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ù‚Ù†Ø§Ø© ÙˆØ§Ø­Ø¯</label>
      <input type="text" id="singleUrl" placeholder="https://example.com/channel.m3u8">
    </div>
    <div class="input-group">
      <label><i class="fas fa-sort-numeric-up"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù…Ø±Ø§Ø¯ ÙØ­ØµÙ‡Ø§</label>
      <input type="number" id="limit" placeholder="Ù…Ø«Ø§Ù„: 50" min="1">
    </div>
    <div class="input-group">
      <label><i class="fas fa-search"></i> Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ù†Ø§Ø© Ø¨Ø§Ù„Ø§Ø³Ù…</label>
      <input type="text" id="search" placeholder="Ù…Ø«Ø§Ù„: bein">
    </div>
    <div class="input-group">
      <label><i class="fas fa-video"></i> Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
      <select id="contentType">
        <option value="all">Ø§Ù„ÙƒÙ„</option>
        <option value="video">ÙÙŠØ¯ÙŠÙˆ</option>
        <option value="audio">ØµÙˆØª</option>
      </select>
    </div>
    <div class="input-group">
      <button onclick="checkM3U()" id="startBtn" class="btn btn-primary"><i class="fas fa-play"></i> Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙØ­Øµ / Ø§Ø³ØªØ¦Ù†Ø§Ù</button>
      <button onclick="stopCheck()" id="stopBtn" class="btn btn-stop" style="display:none;"><i class="fas fa-stop"></i> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙØ­Øµ</button>
      <button onclick="clearResults()" id="clearBtn" class="btn btn-clear"><i class="fas fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
    </div>
    <div id="progressContainer">
      <div id="progressBar">0%</div>
    </div>
    <div id="stats">
      <span>Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµØ§Ù„Ø­Ø©: <span id="validCount">0</span></span>
      <span>Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ØºÙŠØ± Ø§Ù„ØµØ§Ù„Ø­Ø©: <span id="invalidCount">0</span></span>
      <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="totalCount">0</span></span>
    </div>
    <div id="loader" class="loader"></div>
    <div id="results"></div>
    <div class="video-player" id="videoPlayer">
      <video id="player" controls></video>
    </div>
    <div class="input-group">
      <button id="downloadBtn" style="display:none;" onclick="downloadCleaned('m3u')" class="btn btn-primary"><i class="fas fa-download"></i> ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµØ§Ù„Ø­Ø© (M3U)</button>
      <button id="downloadJsonBtn" style="display:none;" onclick="downloadCleaned('json')" class="btn btn-primary"><i class="fas fa-file-code"></i> ØªÙ†Ø²ÙŠÙ„ ÙƒÙ€ JSON</button>
      <button id="downloadCsvBtn" style="display:none;" onclick="downloadCleaned('csv')" class="btn btn-primary"><i class="fas fa-file-csv"></i> ØªÙ†Ø²ÙŠÙ„ ÙƒÙ€ CSV</button>
    </div>
  </div>

  <script>
    let validEntries = [];
    let invalidEntries = [];
    let stopFlag = false;
    let urls = [];
    let currentIndex = 0;
    let total = 0;
    let validCount = 0;
    let invalidCount = 0;

    const defaultImage = "https://via.placeholder.com/80?text=ğŸ“º";

    window.onload = () => {
      const savedUrl = localStorage.getItem('lastListUrl');
      const savedLimit = localStorage.getItem('lastLimit');
      const savedDarkMode = localStorage.getItem('darkMode') === 'true';
      const savedState = localStorage.getItem('checkState');

      if (savedUrl) document.getElementById('listUrl').value = savedUrl;
      if (savedLimit) document.getElementById('limit').value = savedLimit;
      if (savedDarkMode) {
        document.getElementById('darkModeToggle').checked = true;
        toggleDarkMode();
      }
      if (savedState) {
        const state = JSON.parse(savedState);
        validEntries = state.validEntries || [];
        invalidEntries = state.invalidEntries || [];
        urls = state.urls || [];
        currentIndex = state.currentIndex || 0;
        total = state.total || 0;
        validCount = state.validCount || 0;
        invalidCount = state.invalidCount || 0;
        updateStats();
        updateProgress();
        restoreResults();
        showDownloadButtons();
      }
    };

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    function saveState() {
      const state = {
        validEntries,
        invalidEntries,
        urls,
        currentIndex,
        total,
        validCount,
        invalidCount
      };
      localStorage.setItem('checkState', JSON.stringify(state));
    }

    function createChannelElement({ channelName, logo, isValid, url }) {
      if (!isValid) return null;
      const div = document.createElement('div');
      div.className = `channel-item ok`;
      div.innerHTML = `
        <img src="${logo || defaultImage}" alt="${channelName}" loading="lazy" onerror="this.src='${defaultImage}'" style="width: 60px; height: 60px; object-fit: contain;">
        <span>âœ… ${channelName}</span>
        <button class="play-btn" onclick="playChannel('${url}')"><i class="fas fa-play"></i> ØªØ´ØºÙŠÙ„</button>
      `;
      return div;
    }

    function preloadImage(url) {
      return new Promise((resolve) => {
        if (!url || url.trim() === '') return resolve(defaultImage);
        const img = new Image();
        img.src = url;
        img.onload = () => resolve(url);
        img.onerror = () => resolve(defaultImage);
        setTimeout(() => resolve(defaultImage), 3000);
      });
    }

    function playChannel(url) {
      if (url) {
        const player = document.getElementById('player');
        const videoPlayer = document.getElementById('videoPlayer');
        player.src = url;
        videoPlayer.style.display = 'block';
        player.play().catch(() => {
          window.open(url, '_blank');
        });
      } else {
        alert('âš ï¸ Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±');
      }
    }

    async function checkM3U() {
      stopFlag = false;
      document.getElementById("stopBtn").style.display = "inline-block";
      document.getElementById("startBtn").disabled = true;
      document.getElementById("downloadBtn").style.display = "none";
      document.getElementById("downloadJsonBtn").style.display = "none";
      document.getElementById("downloadCsvBtn").style.display = "none";
      document.getElementById("loader").style.display = "block";

      if (urls.length === 0) {
        const file = document.getElementById('fileInput').files[0];
        const listUrl = document.getElementById('listUrl').value.trim();
        const singleUrl = document.getElementById('singleUrl').value.trim();
        const limit = parseInt(document.getElementById('limit').value) || Infinity;
        const searchTerm = document.getElementById('search').value.trim().toLowerCase();
        const contentType = document.getElementById('contentType').value;

        localStorage.setItem('lastListUrl', listUrl);
        localStorage.setItem('lastLimit', limit);

        let text = "";
        if (file) {
          text = await file.text();
        } else if (listUrl) {
          try {
            const res = await fetch(listUrl, { timeout: 10000 });
            if (!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù');
            text = await res.text();
          } catch (e) {
            alert(`âŒ Ø®Ø·Ø£: ${e.message}`);
            resetButtons();
            return;
          }
        } else if (singleUrl) {
          text = "#EXTM3U\n#EXTINF:-1, Ù‚Ù†Ø§Ø© ÙˆØ§Ø­Ø¯Ø©\n" + singleUrl;
        } else {
          alert("ğŸ“Œ Ø§Ø®ØªØ± Ù…Ù„Ù Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø£ÙˆÙ„Ø§Ù‹");
          resetButtons();
          return;
        }

        const lines = text.split(/\r?\n/);
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = "";
        validEntries = [];
        invalidEntries = [];
        urls = [];
        validCount = 0;
        invalidCount = 0;

        let allUrls = [];
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].startsWith("http")) {
            let info = lines[i-1] || "";
            if (!searchTerm || info.toLowerCase().includes(searchTerm)) {
              if (contentType === 'all' || 
                  (contentType === 'video' && lines[i].includes('.m3u8')) || 
                  (contentType === 'audio' && !lines[i].includes('.m3u8'))) {
                let channelName = info.includes(',') ? info.split(',')[1].trim() : "Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©";
                let logo = '';
                if (info.includes('tvg-logo="')) {
                  const match = info.match(/tvg-logo="([^"]+)"/);
                  if (match) logo = match[1];
                }
                allUrls.push({ info, url: lines[i], channelName, checked: false, logo });
              }
            }
          }
        }

        if (allUrls.length > 0) {
          const shuffle = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
          };
          urls = shuffle(allUrls).slice(0, Math.min(allUrls.length, limit));
          total = urls.length;
        } else {
          alert("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±ÙˆØ§Ø¨Ø· Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«");
          resetButtons();
          return;
        }

        updateStats();
        saveState();
      }

      const resultsDiv = document.getElementById('results');
      const batchSize = 10;
      const fragment = document.createDocumentFragment();

      while (currentIndex < total && !stopFlag) {
        const batch = urls.slice(currentIndex, currentIndex + batchSize);
        const promises = batch.map(async ({ info, url, channelName, logo }, idx) => {
          if (urls[currentIndex + idx].checked) return;
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            const res = await fetch(url, { method: "HEAD", signal: controller.signal });
            clearTimeout(timeoutId);

            if (res.ok) {
              const preloadedLogo = await preloadImage(logo || defaultImage);
              const channelElement = createChannelElement({ channelName, logo: preloadedLogo, isValid: true, url });
              if (channelElement) fragment.appendChild(channelElement);
              validEntries.push(info, url);
              validCount++;
            } else {
              invalidEntries.push({ info, url, error: `Ø­Ø§Ù„Ø©: ${res.status}` });
              invalidCount++;
            }
          } catch (e) {
            const errorMsg = e.name === 'AbortError' ? 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø©' : e.message;
            invalidEntries.push({ info, url, error: errorMsg });
            invalidCount++;
          }
          urls[currentIndex + idx].checked = true;
          updateProgress();
          saveState();
        });

        await Promise.all(promises);
        resultsDiv.appendChild(fragment);
        currentIndex += batchSize;
        updateStats();
        saveState();
        await new Promise(r => setTimeout(r, 100));
      }

      document.getElementById("loader").style.display = "none";
      if (stopFlag) {
        resetButtons();
        showDownloadButtons();
        saveState();
        return;
      }

      resetButtons();
      showDownloadButtons();
    }

    function restoreResults() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';
      const fragment = document.createDocumentFragment();
      urls.forEach(({ info, url, channelName, checked, logo }) => {
        if (checked && validEntries.includes(url)) {
          const channelElement = createChannelElement({ channelName, logo, isValid: true, url });
          if (channelElement) fragment.appendChild(channelElement);
        }
      });
      resultsDiv.appendChild(fragment);
    }

    function updateProgress() {
      const progress = Math.round((currentIndex / total) * 100);
      document.getElementById("progressBar").style.width = progress + "%";
      document.getElementById("progressBar").innerText = progress + "%";
    }

    function updateStats() {
      document.getElementById("validCount").innerText = validCount;
      document.getElementById("invalidCount").innerText = invalidCount;
      document.getElementById("totalCount").innerText = total;
    }

    function resetButtons() {
      document.getElementById("stopBtn").style.display = "none";
      document.getElementById("startBtn").disabled = false;
      document.getElementById("loader").style.display = "none";
    }

    function showDownloadButtons() {
      if (validEntries.length > 0) {
        document.getElementById("downloadBtn").style.display = "inline-block";
        document.getElementById("downloadJsonBtn").style.display = "inline-block";
        document.getElementById("downloadCsvBtn").style.display = "inline-block";
      }
    }

    function stopCheck() {
      stopFlag = true;
    }

    function clearResults() {
      document.getElementById('results').innerHTML = '';
      document.getElementById('videoPlayer').style.display = 'none';
      validEntries = [];
      invalidEntries = [];
      urls = [];
      validCount = 0;
      invalidCount = 0;
      total = 0;
      currentIndex = 0;
      updateStats();
      updateProgress();
      document.getElementById("downloadBtn").style.display = "none";
      document.getElementById("downloadJsonBtn").style.display = "none";
      document.getElementById("downloadCsvBtn").style.display = "none";
      localStorage.removeItem('checkState');
    }

    function downloadCleaned(format) {
      let content, type, filename;
      if (format === 'm3u') {
        content = "#EXTM3U\n" + validEntries.join("\n") + "\n";
        type = "audio/x-mpegurl";
        filename = "cleaned.m3u";
      } else if (format === 'json') {
        const data = [];
        for (let i = 0; i < validEntries.length; i += 2) {
          data.push({ info: validEntries[i], url: validEntries[i + 1] });
        }
        content = JSON.stringify(data, null, 2);
        type = "application/json";
        filename = "cleaned.json";
      } else if (format === 'csv') {
        content = "Info,URL\n";
        for (let i = 0; i < validEntries.length; i += 2) {
          content += `"${validEntries[i].replace(/"/g, '""')}","${validEntries[i + 1]}"\n`;
        }
        type = "text/csv";
        filename = "cleaned.csv";
      }

      const blob = new Blob([content], { type });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }
  </script>
</body>
</html>