<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TV-10 â€” IPTV Player (Full)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    :root{
      --bg:#0b0d12;--panel:#0f1220;--panel2:#141a2e;--panel3:#0d1022;--accent:#00c2ff;--accent2:#00ffa9;--danger:#ff3b30;--warning:#ffb020;--ok:#20d34a;--text:#e8ecf6;--muted:#a8b2c7;--ring:rgba(0,194,255,.28);
      --radius:16px;--radius-sm:10px;--shadow:0 10px 28px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(160deg,#0b0d12,#0f142b 60%,#0b0d12);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Kufi Arabic",Tahoma,Arial,sans-serif}

    /* Layout */
    .app{display:grid;grid-template-columns:340px 1fr;grid-template-rows:auto 1fr auto;gap:14px;height:100vh;padding:14px}
    .header{grid-column:1/3;background:var(--panel2);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;align-items:center;gap:12px;padding:12px 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.4px}
    .brand i{color:var(--accent)}
    .searchbar{display:flex;gap:8px;flex:1}
    .searchbar input{flex:1;border:0;border-radius:999px;background:#0f1424;color:var(--text);padding:12px 16px;font-size:14px;outline:2px solid transparent}
    .searchbar input:focus{outline-color:#20315d}
    .searchbar .btn{border:0;border-radius:999px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#001018;padding:12px 16px;font-weight:800;cursor:pointer}

    .sidebar{grid-row:2/4;background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden}
    .filters{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:10px;background:#0e1425;border-bottom:1px solid rgba(255,255,255,.08)}
    .filters select,.filters button{border:0;border-radius:var(--radius-sm);background:#121a2e;color:var(--text);padding:10px;font-size:13px}
    .filters button{cursor:pointer}
    .filters .danger{background:#2b1115;color:#ffd4d1;border:1px solid rgba(255,76,76,.5)}

    .list{flex:1;overflow:auto;padding:10px}
    .channel{display:grid;grid-template-columns:44px 1fr auto;gap:10px;align-items:center;padding:10px;border-radius:12px;background:rgba(255,255,255,.02);margin:6px 0;border:1px solid rgba(255,255,255,.06)}
    .channel:hover{background:rgba(255,255,255,.04)}
    .channel.active{outline:2px solid var(--accent)}
    .logo{width:44px;height:44px;display:grid;place-items:center;border-radius:10px;background:#0f1424;border:1px solid rgba(255,255,255,.06);overflow:hidden}
    .logo img{width:100%;height:100%;object-fit:cover}
    .meta{display:flex;flex-direction:column;gap:2px}
    .meta .name{font-weight:700}
    .meta .tag{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px}
    .iconbtn{width:36px;height:36px;display:grid;place-items:center;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);cursor:pointer}
    .iconbtn.fav.active{background:linear-gradient(135deg,#ff6a6a,#ffb86b);color:#300}

    .player{grid-column:2/3;grid-row:2/3;background:#000;border-radius:var(--radius);box-shadow:var(--shadow);position:relative;overflow:hidden;min-height:56vh}
    video{width:100%;height:100%;object-fit:contain;background:#000}

    /* Player overlays */
    .hud{position:absolute;inset:0;pointer-events:none}
    .center-msg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.85);border:1px solid rgba(255,255,255,.15);backdrop-filter:blur(6px);color:#fff;padding:18px 26px;border-radius:16px;font-size:22px;font-weight:800;display:none;z-index:30;text-align:center;min-width:320px;animation:fadeInOut 3s ease forwards}
    @keyframes fadeInOut{0%{opacity:0}10%{opacity:1}90%{opacity:1}100%{opacity:0}}

    .loader{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:64px;height:64px;border:5px solid #2b395f;border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;display:none;z-index:20}
    @keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}

    .infobar{position:absolute;left:10px;right:10px;bottom:10px;background:rgba(12,14,20,.62);border:1px solid rgba(255,255,255,.08);backdrop-filter:blur(8px);color:#fff;padding:8px 12px;border-radius:12px;display:flex;align-items:center;gap:10px;z-index:15}
    .infobar .dot{width:10px;height:10px;border-radius:999px}
    .infobar .ok{background:var(--ok)}
    .infobar .warn{background:var(--warning)}
    .infobar .bad{background:var(--danger)}
    .infobar .text{flex:1;opacity:.9;font-size:13px}
    .infobar .pill{border:1px solid rgba(255,255,255,.15);padding:6px 10px;border-radius:999px;display:flex;align-items:center;gap:8px}

    .footer{grid-column:2/3;background:var(--panel2);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
    .controls{display:flex;align-items:center;gap:8px}
    .controls .btn{border:0;border-radius:10px;background:#151a2b;color:var(--text);padding:10px 12px;cursor:pointer;border:1px solid rgba(255,255,255,.1)}
    .controls .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#001018;border:none;font-weight:800}
    .controls .btn.danger{background:#2b0f12;color:#ffd5d1;border-color:#ff4b4b}

    /* Remote overlay (optional on-screen buttons) */
    .remote{position:absolute;top:12px;right:12px;display:flex;gap:8px;z-index:22}
    .remote .iconbtn{backdrop-filter:blur(6px)}

    /* Scrollbar */
    .list{scrollbar-width:thin;scrollbar-color:#33415f transparent}
    .list::-webkit-scrollbar{width:10px}
    .list::-webkit-scrollbar-thumb{background:#2c3856;border-radius:999px}

    @media(max-width:980px){
      .app{grid-template-columns:1fr;grid-template-rows:auto 1fr auto auto}
      .sidebar{grid-column:1/2;grid-row:auto}
      .player{grid-column:1/2;grid-row:auto;height:52vh}
      .footer{grid-column:1/2}
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- Header -->
    <header class="header">
      <div class="brand"><i class="fa-solid fa-tv"></i> TVâ€‘10 IPTV</div>
      <div class="searchbar">
        <input id="q" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ù†Ø§Ø©â€¦ / Search channels" />
        <button class="btn" id="clearSearch" title="Ù…Ø³Ø­"><i class="fa-solid fa-xmark"></i></button>
        <button class="btn" id="shuffle" title="ØªØ´ØºÙŠÙ„ Ù‚Ù†Ø§Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©"><i class="fa-solid fa-shuffle"></i> Ø¹Ø´ÙˆØ§Ø¦ÙŠ</button>
      </div>
      <div class="pill"><i class="fa-solid fa-circle-info"></i> Ù†Ø³Ø®Ø© ÙƒØ§Ù…Ù„Ø© + Ø±Ø³Ø§Ø¦Ù„ ÙˆØ³Ø· Ø§Ù„Ø´Ø§Ø´Ø©</div>
    </header>

    <!-- Sidebar: filters + list -->
    <aside class="sidebar">
      <div class="filters">
        <select id="genre">
          <option value="">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>
          <option>Ø±ÙŠØ§Ø¶Ø©</option>
          <option>Ø£Ø®Ø¨Ø§Ø±</option>
          <option>Ø£ÙÙ„Ø§Ù…</option>
          <option>ÙˆØ«Ø§Ø¦Ù‚ÙŠ</option>
          <option>Ù…Ù†ÙˆØ¹Ø§Øª</option>
        </select>
        <select id="country">
          <option value="">ÙƒÙ„ Ø§Ù„Ø¯ÙˆÙ„</option>
          <option>DZ</option>
          <option>MA</option>
          <option>TN</option>
          <option>EG</option>
          <option>SA</option>
          <option>QA</option>
          <option>FR</option>
          <option>UK</option>
        </select>
        <button id="showFavs" class="btn">â¤ï¸ Ø§Ù„Ù…ÙØ¶Ù„Ø©</button>
        <button id="exportFavs" class="btn">â¬‡ï¸ ØªØµØ¯ÙŠØ±</button>
      </div>
      <div class="list" id="list"></div>
    </aside>

    <!-- Player -->
    <main class="player" id="player">
      <video id="video" autoplay playsinline></video>
      <div class="hud">
        <div class="loader" id="loader"></div>
        <div class="center-msg" id="centerMsg"></div>
        <div class="remote">
          <button class="iconbtn" id="btnPrev" title="Ø§Ù„Ø³Ø§Ø¨Ù‚"><i class="fa-solid fa-backward-step"></i></button>
          <button class="iconbtn" id="btnPlay" title="ØªØ´ØºÙŠÙ„ / Ø¥ÙŠÙ‚Ø§Ù"><i class="fa-solid fa-play"></i></button>
          <button class="iconbtn" id="btnNext" title="Ø§Ù„ØªØ§Ù„ÙŠ"><i class="fa-solid fa-forward-step"></i></button>
          <button class="iconbtn" id="btnFull" title="Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©"><i class="fa-solid fa-expand"></i></button>
        </div>
        <div class="infobar" id="infobar">
          <div class="dot ok" id="netDot"></div>
          <div class="text" id="status">Ø¬Ø§Ù‡Ø²</div>
          <div class="pill" id="pillInfo"><i class="fa-solid fa-wifi"></i> Ø§Ù„Ø´Ø¨ÙƒØ© Ù…Ø³ØªÙ‚Ø±Ø©</div>
        </div>
      </div>
    </main>

    <!-- Footer controls -->
    <footer class="footer">
      <div class="controls">
        <button class="btn primary" id="retry"><i class="fa-solid fa-rotate-right"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
        <button class="btn" id="mute"><i class="fa-solid fa-volume-xmark"></i> ÙƒØªÙ…</button>
        <button class="btn" id="pip"><i class="fa-regular fa-clone"></i> ØµÙˆØ±Ø© Ø¯Ø§Ø®Ù„ ØµÙˆØ±Ø©</button>
        <button class="btn" id="lowData"><i class="fa-solid fa-gauge"></i> ÙˆØ¶Ø¹ Ø¨Ø·ÙŠØ¡</button>
        <button class="btn danger" id="stop"><i class="fa-solid fa-stop"></i> Ø¥ÙŠÙ‚Ø§Ù</button>
      </div>
      <div class="controls">
        <button class="btn" id="saveM3U"><i class="fa-solid fa-file-export"></i> Ø­ÙØ¸ Ø§Ù„Ù‚Ù†ÙˆØ§Øª</button>
        <label class="btn" for="m3uFile"><i class="fa-solid fa-file-import"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯</label>
        <input type="file" id="m3uFile" accept=".m3u,.m3u8" hidden />
      </div>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    // ======= Data & State =======
    const video = document.getElementById('video');
    const centerMsg = document.getElementById('centerMsg');
    const loader = document.getElementById('loader');
    const statusEl = document.getElementById('status');
    const netDot = document.getElementById('netDot');
    const pillInfo = document.getElementById('pillInfo');

    const listEl = document.getElementById('list');
    const q = document.getElementById('q');
    const clearSearch = document.getElementById('clearSearch');
    const genreSel = document.getElementById('genre');
    const countrySel = document.getElementById('country');

    const btnPrev = document.getElementById('btnPrev');
    const btnPlay = document.getElementById('btnPlay');
    const btnNext = document.getElementById('btnNext');
    const btnFull = document.getElementById('btnFull');

    const btnRetry = document.getElementById('retry');
    const btnMute = document.getElementById('mute');
    const btnPip = document.getElementById('pip');
    const btnStop = document.getElementById('stop');
    const btnLowData = document.getElementById('lowData');

    const btnShowFavs = document.getElementById('showFavs');
    const btnExportFavs = document.getElementById('exportFavs');
    const btnShuffle = document.getElementById('shuffle');

    const m3uFile = document.getElementById('m3uFile');

    let hls = null;
    let allChannels = [];
    let filteredChannels = [];
    let favorites = JSON.parse(localStorage.getItem('favorites')||'[]');
    let onlyFavs = false;
    let currentIndex = -1;

    // Poor network handling
    let lowDataMode = JSON.parse(localStorage.getItem('lowDataMode')||'false');
    let retryAttempts = 0;
    let retryTimer = null;

    // ======= Floating message helper (center overlay) =======
    function showCenterMessage(text){
      centerMsg.textContent = text;
      centerMsg.style.display = 'block';
      clearTimeout(showCenterMessage._t);
      showCenterMessage._t = setTimeout(()=>{
        centerMsg.style.display = 'none';
      }, 3000);
    }

    // ======= Status helpers =======
    function setStatus(text, type='ok'){
      statusEl.textContent = text;
      netDot.className = 'dot ' + (type==='ok'?'ok':type==='warn'?'warn':'bad');
      pillInfo.innerHTML = type==='ok' ? '<i class="fa-solid fa-wifi"></i> Ø§Ù„Ø´Ø¨ÙƒØ© Ù…Ø³ØªÙ‚Ø±Ø©' : (type==='warn' ? '<i class="fa-solid fa-circle-exclamation"></i> Ø§ØªØµØ§Ù„ Ø¶Ø¹ÙŠÙ' : '<i class="fa-solid fa-triangle-exclamation"></i> Ù„Ø§ Ø§ØªØµØ§Ù„');
    }

    function scheduleRetry(){
      clearTimeout(retryTimer);
      const delay = Math.min(30000, 1000 * Math.pow(2, Math.max(0, retryAttempts-1))); // 1s,2s,4s,... up to 30s
      let left = Math.round(delay/1000);
      setStatus('Ø§ØªØµØ§Ù„ Ø¶Ø¹ÙŠÙ â€“ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø®Ù„Ø§Ù„ '+left+' Ø«', 'warn');
      showCenterMessage('Poor Connection');
      retryTimer = setInterval(()=>{
        left--; if(left<=0){ clearInterval(retryTimer); retryTimer=null; if(currentIndex>-1){ retryAttempts++; playAt(currentIndex); } return; }
        statusEl.textContent = 'Ø§ØªØµØ§Ù„ Ø¶Ø¹ÙŠÙ â€“ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø®Ù„Ø§Ù„ '+left+' Ø«';
      }, 1000);
    }

    function clearRetry(){
      if(retryTimer){ clearInterval(retryTimer); retryTimer=null; }
      retryAttempts = 0;
    }

    // ======= Render list =======
    function renderList(){
      listEl.innerHTML = '';
      const list = filteredChannels.length ? filteredChannels : allChannels;
      list.forEach((ch, idx)=>{
        if(onlyFavs && !favorites.includes(ch.id)) return;
        const item = document.createElement('div');
        item.className = 'channel' + (idx===currentIndex?' active':'');
        item.dataset.index = idx;
        item.innerHTML = `
          <div class="logo">${ch.logo?`<img src="${ch.logo}" alt="">`:'ğŸ“º'}</div>
          <div class="meta">
            <div class="name">${ch.name||'Channel'}</div>
            <div class="tag">${[ch.country, ch.group].filter(Boolean).join(' â€¢ ')}</div>
          </div>
          <div class="actions">
            <button class="iconbtn play" title="ØªØ´ØºÙŠÙ„"><i class="fa-solid fa-play"></i></button>
            <button class="iconbtn fav ${favorites.includes(ch.id)?'active':''}" title="Ù…ÙØ¶Ù„Ø©"><i class="fa-solid fa-heart"></i></button>
          </div>
        `;
        item.querySelector('.play').onclick = ()=> playAt(idx);
        item.querySelector('.fav').onclick = (e)=>{
          e.stopPropagation();
          toggleFavorite(ch.id, e.currentTarget);
        };
        item.onclick = ()=> playAt(idx);
        listEl.appendChild(item);
      });
    }

    function toggleFavorite(id, btn){
      const i = favorites.indexOf(id);
      if(i===-1) favorites.push(id); else favorites.splice(i,1);
      localStorage.setItem('favorites', JSON.stringify(favorites));
      if(btn){ btn.classList.toggle('active'); }
    }

    // ======= Filtering =======
    function applyFilters(){
      const term = (q.value||'').toLowerCase();
      const g = (genreSel.value||'').toLowerCase();
      const c = (countrySel.value||'').toLowerCase();
      filteredChannels = allChannels.filter(ch=>{
        if(g && (!ch.group || ch.group.toLowerCase().indexOf(g)===-1)) return false;
        if(c && (!ch.country || ch.country.toLowerCase().indexOf(c)===-1)) return false;
        if(term){
          const blob = `${ch.name||''} ${ch.group||''} ${ch.country||''}`.toLowerCase();
          if(blob.indexOf(term)===-1) return false;
        }
        return true;
      });
      renderList();
    }

    q.addEventListener('input', applyFilters);
    clearSearch.addEventListener('click', ()=>{ q.value=''; applyFilters(); });
    genreSel.addEventListener('change', applyFilters);
    countrySel.addEventListener('change', applyFilters);

    btnShowFavs.addEventListener('click', ()=>{ onlyFavs = !onlyFavs; renderList(); btnShowFavs.textContent = onlyFavs ? 'ğŸ’” Ø§Ù„ÙƒÙ„' : 'â¤ï¸ Ø§Ù„Ù…ÙØ¶Ù„Ø©'; });
    btnShuffle.addEventListener('click', ()=>{
      if(!(filteredChannels.length||allChannels.length)) return;
      const list = filteredChannels.length? filteredChannels: allChannels;
      const idx = Math.floor(Math.random()*list.length);
      const absoluteIndex = (filteredChannels.length? allChannels.indexOf(list[idx]) : idx);
      playAt(absoluteIndex);
    });

    // ======= Player control =======
    function destroyHls(){
      if(hls){ try{ hls.destroy(); }catch(e){} hls=null; }
    }

    function buildHlsConfig(){
      const base = {
        lowLatencyMode:true,
        backBufferLength: 30,
        maxBufferLength: 20,
        maxBufferSize: 30*1000*1000,
        capLevelToPlayerSize: true,
        maxLiveSyncPlaybackRate:1.2
      };
      if(lowDataMode){
        base.startLevel = 0; // pick lowest quality first
        base.autoLevelCapping = 0; // cap at lowest level
        base.maxMaxBufferLength = 10;
        base.fragLoadingTimeOut = 8000;
        base.manifestLoadingTimeOut = 8000;
      }
      return base;
    }

    function playAt(index){
      const list = allChannels;
      if(index<0 || index>=list.length) return;
      currentIndex = index;
      const ch = list[index];

      // highlight
      [...document.querySelectorAll('.channel')].forEach(el=>el.classList.remove('active'));
      const found = [...document.querySelectorAll('.channel')].find(el=>+el.dataset.index===index);
      if(found) found.classList.add('active');

      setStatus('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„: '+(ch.name||''), 'ok');
      loader.style.display = 'block';
      showCenterMessage('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦');

      clearRetry();
      destroyHls();

      if(window.Hls && Hls.isSupported()){
        hls = new Hls(buildHlsConfig());
        hls.attachMedia(video);
        hls.loadSource(ch.url);

        hls.on(Hls.Events.MANIFEST_PARSED, ()=>{
          loader.style.display='none';
          setStatus('ØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„: '+(ch.name||''),'ok');
          video.play().catch(()=>{});
        });

        // adapt to bandwidth
        hls.on(Hls.Events.FRAG_LOADED, (evt, data)=>{
          if(!data || !data.stats) return;
          const bytes = data.stats.total; const ms = (data.stats.tload||0)-(data.stats.trequest||0);
          if(ms>0){
            const mbps = (bytes*8/ms)/1000; // megabits per second approx
            if(lowDataMode){ hls.autoLevelCapping = 0; }
            else if(mbps < 1500){ hls.autoLevelCapping = 0; setStatus('ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬ÙˆØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ù…Ù†Ø®ÙØ¶Ø©)','warn'); }
            else if(mbps < 3000){ hls.autoLevelCapping = 1; setStatus('ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬ÙˆØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ù…ØªÙˆØ³Ø·Ø©)','warn'); }
            else { hls.autoLevelCapping = -1; }
          }
        });

        hls.on(Hls.Events.ERROR, (evt, data)=>{
          loader.style.display='none';
          console.warn('HLS ERROR', data);
          const d = data.details || '';
          if(d==='manifestLoadError' || d==='manifestParsingError' || d==='levelLoadError'){
            showCenterMessage('Channel Expired');
            setStatus('Ø§Ù„Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠØ©','bad');
          } else if (d==='fragLoadError' || d==='bufferStalledError' || d==='fragLoadTimeout' || (data.type==='networkError')){
            setStatus('Ø§ØªØµØ§Ù„ Ø¶Ø¹ÙŠÙ â€“ Ø³ÙŠÙØ¹Ø§Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹','warn');
            scheduleRetry();
          } else {
            setStatus('Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: '+d,'warn');
          }
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')){
        video.src = ch.url; video.play().catch(()=>{});
      } else {
        video.src = ch.url; video.play().catch(()=>{});
      }

      // remember last
      localStorage.setItem('lastIndex', String(index));
    }

    btnPrev.addEventListener('click', ()=> playAt(Math.max(0, currentIndex-1)) );
    btnNext.addEventListener('click', ()=> playAt(Math.min(allChannels.length-1, currentIndex+1)) );
    btnPlay.addEventListener('click', ()=>{ if(video.paused) { video.play(); } else { video.pause(); } });
    btnFull.addEventListener('click', ()=>{
      const el = document.querySelector('.player');
      if(document.fullscreenElement){ document.exitFullscreen(); }
      else { el.requestFullscreen && el.requestFullscreen(); }
    });

    btnRetry.addEventListener('click', ()=>{ if(currentIndex>-1) playAt(currentIndex); });
    btnMute.addEventListener('click', ()=>{ video.muted = !video.muted; btnMute.innerHTML = video.muted? '<i class="fa-solid fa-volume-xmark"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª' : '<i class="fa-solid fa-volume-xmark"></i> ÙƒØªÙ…'; });
    btnPip.addEventListener('click', async()=>{ if(document.pictureInPictureElement){ await document.exitPictureInPicture(); } else if(video.requestPictureInPicture){ await video.requestPictureInPicture(); }});
    btnStop.addEventListener('click', ()=>{ destroyHls(); video.removeAttribute('src'); video.load(); setStatus('ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù','warn'); clearRetry(); });

    // Low data toggle
    function applyLowDataUI(){ btnLowData.classList.toggle('primary', lowDataMode); btnLowData.textContent = lowDataMode? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø·ÙŠØ¡' : 'ÙˆØ¶Ø¹ Ø¨Ø·ÙŠØ¡'; }
    btnLowData.addEventListener('click', ()=>{ lowDataMode = !lowDataMode; localStorage.setItem('lowDataMode', JSON.stringify(lowDataMode)); applyLowDataUI(); if(currentIndex>-1) playAt(currentIndex); });
    applyLowDataUI();

    // Extra signals for poor connection
    ['waiting','stalled'].forEach(ev=> video.addEventListener(ev, ()=>{ setStatus('Ø§ØªØµØ§Ù„ Ø¶Ø¹ÙŠÙ â€“ ØªØ¬Ù…Ù‘Ø¯ Ø§Ù„Ø¨Ø«','warn'); scheduleRetry(); }));
    video.addEventListener('playing', ()=>{ setStatus('ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†','ok'); clearRetry(); });
    video.addEventListener('error', ()=>{ loader.style.display='none'; showCenterMessage('Channel Expired'); setStatus('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ','bad'); });

    // Network quality (if supported)
    if('connection' in navigator){
      const updateNet = ()=>{
        const c = navigator.connection; // downlink, rtt, effectiveType
        if(!c) return;
        const speed = (c.downlink||0).toFixed(1);
        const rtt = c.rtt||0;
        if(c.effectiveType==='4g' && speed>5 && rtt<100){ setStatus('Ø§Ù„Ø§ØªØµØ§Ù„ Ø¬ÙŠØ¯ ('+speed+'Mbps)','ok'); }
        else if (c.effectiveType==='3g' || speed<3){ setStatus('Ø§ØªØµØ§Ù„ Ù…ØªÙˆØ³Ø· ('+speed+'Mbps)','warn'); }
        else { setStatus('Ø§ØªØµØ§Ù„ Ø¶Ø¹ÙŠÙ','bad'); scheduleRetry(); }
      };
      navigator.connection.addEventListener('change', updateNet);
      updateNet();
    }

    // ======= M3U handling =======
    function parseM3U(text){
      const lines = text.split(/\r?\n/);
      const out=[];
      let cur=null;
      for(const ln of lines){
        if(ln.startsWith('#EXTINF')){
          cur = { id: Math.random().toString(36).slice(2), name:'', group:'', country:'', logo:'', url:'' };
          const name = ln.split(',').slice(1).join(',').trim();
          cur.name = name;
          const tvgLogo = /tvg-logo="([^"]+)"/.exec(ln); if(tvgLogo) cur.logo=tvgLogo[1];
          const group = /group-title="([^"]+)"/.exec(ln); if(group) cur.group=group[1];
          const tvgCountry = /tvg-country="([^"]+)"/.exec(ln); if(tvgCountry) cur.country=tvgCountry[1];
        } else if (ln && !ln.startsWith('#')){
          if(cur){ cur.url = ln.trim(); out.push(cur); cur=null; }
        }
      }
      return out;
    }

    function download(filename, text){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text], {type:'text/plain'}));
      a.download = filename; a.click(); URL.revokeObjectURL(a.href);
    }

    document.getElementById('saveM3U').addEventListener('click', ()=>{
      const channels = allChannels.map(ch=>`#EXTINF:-1 tvg-logo="${ch.logo||''}" group-title="${ch.group||''}",${ch.name}\n${ch.url}`).join('\n');
      download('channels.m3u', '#EXTM3U\n'+channels);
    });

    document.getElementById('m3uFile').addEventListener('change', async(e)=>{
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text();
      const parsed = parseM3U(text);
      if(parsed.length){ allChannels = parsed; localStorage.setItem('m3uChannels', JSON.stringify(parsed)); currentIndex=-1; filteredChannels=[]; renderList(); setStatus('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: '+parsed.length+' Ù‚Ù†Ø§Ø©','ok'); }
      else { setStatus('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­','bad'); }
    });

    btnExportFavs.addEventListener('click', ()=>{
      const favList = allChannels.filter(ch=> favorites.includes(ch.id));
      if(!favList.length){ setStatus('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙØ¶Ù„Ø© Ù„Ù„ØªØµØ¯ÙŠØ±','warn'); return; }
      const m3u = '#EXTM3U\n'+favList.map(ch=>`#EXTINF:-1 tvg-logo="${ch.logo||''}" group-title="${ch.group||''}",${ch.name}\n${ch.url}`).join('\n');
      download('favorites.m3u', m3u);
    });

    function restore(){
      const saved = JSON.parse(localStorage.getItem('m3uChannels')||'[]');
      if(saved.length){ allChannels = saved; }
      else {
        // Fallback demo channels
        allChannels = [
          {id:'c1', name:'Mux Test', group:'Sports', country:'US', logo:'https://dummyimage.com/120x120/0bf/fff&text=MUX', url:'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8'},
          {id:'c2', name:'Big Buck', group:'Movies', country:'US', logo:'https://dummyimage.com/120x120/08f/fff&text=BB', url:'https://storage.googleapis.com/shaka-demo-assets/angel-one-hls/hls.m3u8'},
          {id:'c3', name:'Tears of Steel', group:'Movies', country:'UK', logo:'https://dummyimage.com/120x120/06c/fff&text=TOS', url:'https://test-streams.mux.dev/ptsVOD/ptsVOD.m3u8'}
        ];
      }
      // ensure ids
      allChannels = allChannels.map(ch=> ({ id: ch.id||Math.random().toString(36).slice(2), ...ch }));
      // try resume
      const last = +localStorage.getItem('lastIndex');
      renderList();
      if(!isNaN(last) && last>=0 && last<allChannels.length) playAt(last);
    }

    // init
    restore();
    applyFilters();
  </script>
</body>
</html>
